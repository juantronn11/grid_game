{% extends "base.html" %}
{% block title %}Create Game{% endblock %}
{% block content %}
<div class="card center-card">
    <h2>Create New Game</h2>
    <form method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <label for="espn_league">Link to ESPN Game (optional)</label>
        <select id="espn_league" class="input" onchange="loadEspnGames()">
            <option value="">-- No live tracking --</option>
            <option value="nfl">NFL</option>
            <option value="college-football">College Football</option>
        </select>
        <select id="espn_game" class="input" style="display:none" onchange="fillTeams()">
            <option value="">-- Select a game --</option>
        </select>
        <input type="hidden" name="espn_event_id" id="espn_event_id" value="">

        <label for="name">Game Name</label>
        <input type="text" name="name" id="name" placeholder="e.g. Super Bowl 2026" required class="input">

        <label for="team_x">Team (columns — top axis)</label>
        <input type="text" name="team_x" id="team_x" placeholder="e.g. Chiefs" required class="input">

        <label for="team_y">Team (rows — left axis)</label>
        <input type="text" name="team_y" id="team_y" placeholder="e.g. Eagles" required class="input">

        <div class="payment-section">
            <label>Payment Methods</label>
            <div id="paymentRows"></div>
            <button type="button" class="btn btn-secondary btn-small" onclick="addPaymentRow()">+ Add Payment Method</button>
        </div>

        <label for="square_price">Price Per Square</label>
        <input type="text" name="square_price" id="square_price" placeholder="e.g. $10 a square" class="input">

        <label for="payout_info">Payout Info</label>
        <input type="text" name="payout_info" id="payout_info" placeholder="e.g. $50 per quarter" class="input">

        <label for="lock_at">Game Start Time (auto-locks grid)</label>
        <input type="datetime-local" name="lock_at" id="lock_at" class="input">

        <label for="max_claims">Max Squares Per Player (0 = unlimited)</label>
        <input type="number" name="max_claims" id="max_claims" placeholder="e.g. 5" min="0" value="0" class="input">

        <label for="custom_code">Game Code (optional — 6 alphanumeric characters, or leave blank to auto-generate)</label>
        <input type="text" name="custom_code" id="custom_code" placeholder="e.g. ABC123" maxlength="6" pattern="[A-Za-z0-9]{6}" class="input" style="text-transform:uppercase">

        <label for="discord_webhook">Discord Webhook URL (optional)</label>
        <input type="url" name="discord_webhook" id="discord_webhook" placeholder="https://discord.com/api/webhooks/..." class="input">

        <label for="password">Admin Password</label>
        <input type="password" name="password" id="password" placeholder="Min 4 characters" required minlength="4" class="input">

        <label for="confirm">Confirm Password</label>
        <input type="password" name="confirm" id="confirm" placeholder="Confirm password" required class="input">

        <button type="submit" class="btn btn-primary">Create Game</button>
    </form>
</div>

<script>
var espnGames = [];

function loadEspnGames() {
    var league = document.getElementById('espn_league').value;
    var sel = document.getElementById('espn_game');
    var hidden = document.getElementById('espn_event_id');
    if (!league) {
        sel.style.display = 'none';
        hidden.value = '';
        espnGames = [];
        return;
    }
    sel.innerHTML = '<option value="">Loading...</option>';
    sel.style.display = '';
    fetch('/api/espn-games/' + league)
        .then(function(r) { return r.json(); })
        .then(function(games) {
            espnGames = games;
            sel.innerHTML = '<option value="">-- Select a game --</option>';
            games.forEach(function(g) {
                var opt = document.createElement('option');
                opt.value = g.event_id;
                opt.textContent = g.away_team + ' at ' + g.home_team + ' — ' + g.status;
                sel.appendChild(opt);
            });
        })
        .catch(function() {
            sel.innerHTML = '<option value="">Failed to load games</option>';
        });
}

function fillTeams() {
    var eventId = document.getElementById('espn_game').value;
    document.getElementById('espn_event_id').value = eventId;
    if (!eventId) return;
    for (var i = 0; i < espnGames.length; i++) {
        if (espnGames[i].event_id === eventId) {
            document.getElementById('team_x').value = espnGames[i].home_team;
            document.getElementById('team_y').value = espnGames[i].away_team;
            document.getElementById('name').value = espnGames[i].name;
            break;
        }
    }
}

let paymentCount = 0;
function addPaymentRow() {
    const i = paymentCount++;
    const row = document.createElement('div');
    row.className = 'payment-row';
    row.innerHTML =
        '<input type="text" name="pay_label_' + i + '" placeholder="e.g. CashApp, Venmo" required class="input payment-input">' +
        '<input type="text" name="pay_user_' + i + '" placeholder="Username / handle" required class="input payment-input">' +
        '<button type="button" class="btn btn-small btn-ban" onclick="this.parentElement.remove()">&times;</button>';
    document.getElementById('paymentRows').appendChild(row);
    document.querySelector('input[name="payment_count"]')?.remove();
    const hidden = document.createElement('input');
    hidden.type = 'hidden';
    hidden.name = 'payment_count';
    hidden.value = paymentCount;
    document.getElementById('paymentRows').appendChild(hidden);
}
</script>
{% endblock %}
