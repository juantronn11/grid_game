{% extends "base.html" %}
{% block title %}Admin: {{ game["name"] }}{% endblock %}
{% block content %}
<div class="admin-nav">
    <a href="{{ url_for('admin_dashboard') }}">Dashboard</a>
    <span class="nav-sep">/</span>
    <span class="nav-current">{{ game["name"] }}</span>
</div>

<div class="admin-tabs">
    <a href="{{ url_for('admin_panel', game_id=game_id) }}" class="tab tab-active">Grid</a>
    <a href="{{ url_for('admin_players', game_id=game_id) }}" class="tab">Players ({{ player_count }}){% if pending_request_count %} <span class="badge badge-blue">{{ pending_request_count }} req</span>{% endif %}</a>
</div>

{% if pending_request_count %}
<div class="banner banner-reveal">
    {{ pending_request_count }} player{{ "s" if pending_request_count > 1 else "" }} requesting more squares.
    <a href="{{ url_for('admin_players', game_id=game_id) }}" class="btn btn-small" style="margin-left:0.75rem;">Review Requests</a>
</div>
{% endif %}

{% if live_score %}
<div class="scoreboard">
    <div class="scoreboard-team">
        <span class="scoreboard-name">{{ live_score.away_team }}</span>
        <span class="scoreboard-score">{{ live_score.away_score }}</span>
    </div>
    <div class="scoreboard-status">{{ live_score.status_text }}</div>
    <div class="scoreboard-team">
        <span class="scoreboard-name">{{ live_score.home_team }}</span>
        <span class="scoreboard-score">{{ live_score.home_score }}</span>
    </div>
</div>
{% endif %}

<div class="admin-header">
    <div class="admin-info">
        <span class="badge">{{ claim_count }}/100 spots</span>
        <span class="badge">{{ player_count }} players</span>
        {% if locked %}
        <span class="badge badge-red">Locked</span>
        {% endif %}
        {% if game["numbers_released"] %}
        <span class="badge badge-green">Numbers Released</span>
        {% elif game["is_complete"] %}
        <span class="badge badge-blue">Grid Full â€” Numbers Pending Release</span>
        {% elif has_numbers %}
        <span class="badge">Numbers Generated (Not Released)</span>
        {% else %}
        <span class="badge">Numbers Not Generated</span>
        {% endif %}
    </div>
</div>

<div class="share-box">
    <strong>Share with players:</strong>
    <div class="share-url" id="shareUrl">{{ player_url }}</div>
    <button class="btn btn-small" onclick="navigator.clipboard.writeText(document.getElementById('shareUrl').textContent).then(()=>this.textContent='Copied!')">Copy Link</button>
    <span class="share-id">Game ID: <strong>{{ game_id }}</strong></span>
</div>

{% if game["square_price"] or game["payout_info"] %}
<div class="pricing-box">
    {% if game["square_price"] %}<span><strong>Price:</strong> {{ game["square_price"] }}</span>{% endif %}
    {% if game["payout_info"] %}<span><strong>Payout:</strong> {{ game["payout_info"] }}</span>{% endif %}
</div>
{% endif %}

{% if game["lock_at"] %}
<div class="pricing-box">
    <span><strong>Auto-lock at:</strong> {{ game["lock_at"][:16].replace("T", " ") }}</span>
</div>
{% endif %}

<div class="admin-actions">
    <form method="post" action="{{ url_for('admin_lock', game_id=game_id) }}" style="display:inline;"
          onsubmit="return confirm('{{ "Unlock game and remove VOID squares?" if locked else "Lock game and mark unclaimed squares as VOID?" }}')">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn {% if locked %}btn-unban{% else %}btn-lock{% endif %}">
            {% if locked %}Unlock Game{% else %}Lock Game{% endif %}
        </button>
    </form>

    {% if not game["numbers_released"] %}
    <form method="post" action="{{ url_for('admin_release', game_id=game_id) }}" style="display:inline;"
          onsubmit="return confirm('Release numbers to all players now?')">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button type="submit" class="btn btn-release">Release Numbers</button>
    </form>
    {% endif %}

    {% if has_numbers %}
    <a href="{{ url_for('admin_pdf', game_id=game_id) }}" class="btn btn-primary">Download PDF</a>
    {% else %}
    <span class="btn btn-disabled">Download PDF (no numbers yet)</span>
    {% endif %}

    <a href="{{ url_for('game_view', game_id=game_id) }}" target="_blank" class="btn btn-secondary">View as Player</a>
</div>

<div class="grid-wrapper">
    <div class="team-label-x">{{ game["team_x"] }}</div>
    <div class="grid-with-label">
        <div class="team-label-y">{{ game["team_y"] }}</div>
        <table class="game-grid">
            <tr>
                <th class="corner-cell"></th>
                {% for c in range(10) %}
                <th class="number-cell">{% if has_numbers %}{{ col_numbers[c] }}{% else %}?{% endif %}</th>
                {% endfor %}
            </tr>
            {% for r in range(1, 11) %}
            <tr>
                <th class="number-cell">{% if has_numbers %}{{ row_numbers[r-1] }}{% else %}?{% endif %}</th>
                {% for c in range(1, 11) %}
                <td class="{% if grid[r][c] == 'VOID' %}void{% elif grid[r][c] %}claimed{% else %}open{% endif %}">
                    {% if grid[r][c] == 'VOID' %}
                        <span class="void-label">VOID</span>
                    {% elif grid[r][c] %}
                        <span class="player-name">{{ grid[r][c] }}</span>
                        <form method="post" action="{{ url_for('admin_remove', game_id=game_id) }}" class="remove-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="row" value="{{ r }}">
                            <input type="hidden" name="col" value="{{ c }}">
                            <button type="submit" class="remove-btn" title="Remove">&times;</button>
                        </form>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </table>
    </div>
</div>

{% if quarter_results %}
<div class="card quarter-results" style="margin-top:1.5rem;">
    <h3>Quarter Results</h3>
    {% for qr in quarter_results %}
    <div class="qr-row{% if qr.winner %} qr-hit{% endif %}">
        <span class="qr-label">{{ qr.label }}</span>
        <span class="qr-score">{{ game["team_y"] }} {{ qr.away_score }} - {{ game["team_x"] }} {{ qr.home_score }}</span>
        {% if qr.winner %}
        <span class="qr-winner">{{ qr.winner }}</span>
        {% else %}
        <span class="qr-no-winner">No winner</span>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="card" style="margin-top:1.5rem;">
    <h3>Message All Players</h3>
    <form method="post" action="{{ url_for('admin_broadcast', game_id=game_id) }}" class="chat-reply-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="text" name="message" placeholder="Send a message to all players..." maxlength="500" required class="input chat-reply-input">
        <button type="submit" class="btn btn-primary btn-small">Broadcast</button>
    </form>
</div>

{% if chat_threads %}
<div class="card" style="margin-top:1.5rem;">
    <h3>Player Chat ({{ chat_threads|length }} conversation{{ "s" if chat_threads|length > 1 else "" }})
        {% if unread_threads %}<span class="badge badge-orange">{{ unread_threads|length }} new</span>{% endif %}
    </h3>
    {% for player, msgs in chat_threads.items() %}
    <div class="chat-thread-section">
        <button type="button" class="chat-thread-toggle" onclick="this.parentElement.classList.toggle('open')">
            <strong>{{ player }}</strong>
            {% if player in unread_threads %}<span class="badge-unread-dot"></span>{% endif %}
            <span class="chat-count">{{ msgs|length }} msg{{ "s" if msgs|length > 1 else "" }}</span>
        </button>
        <div class="chat-thread-body">
            <div class="chat-thread">
                {% for msg in msgs %}
                <div class="chat-bubble chat-bubble-{{ msg['sender_type'] }}">
                    <span class="chat-sender">{{ "Host" if msg["sender_type"] == "host" else player }}</span>
                    <p>{{ msg["message"] }}</p>
                    <span class="chat-time">{{ msg["sent_at"][:16].replace("T", " ") }}</span>
                </div>
                {% endfor %}
            </div>
            <form method="post" action="{{ url_for('admin_reply', game_id=game_id) }}" class="chat-reply-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="player_name" value="{{ player }}">
                <input type="text" name="message" placeholder="Reply to {{ player }}..." maxlength="500" required class="input chat-reply-input">
                <button type="submit" class="btn btn-primary btn-small">Send</button>
            </form>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}
{% endblock %}
