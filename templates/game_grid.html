{% extends "base.html" %}
{% block title %}{{ game["name"] }}{% endblock %}
{% block head %}
<meta http-equiv="refresh" content="15">
{% endblock %}
{% block content %}
<div class="game-header">
    <h2>{{ game["name"] }}</h2>
    <div class="game-info">
        <span>Playing as: <strong>{{ player_name }}</strong></span>
        <span class="badge">{{ claim_count }}/100 spots filled</span>
    </div>
</div>

{% if locked and not game["numbers_released"] %}
<div class="banner banner-locked">
    Game is locked. No more spots can be claimed.
</div>
{% endif %}

{% if game["numbers_released"] %}
<div class="banner banner-reveal">
    Numbers are in! Check your spots.
    <a href="{{ url_for('player_pdf', game_id=game_id) }}" class="btn btn-small" style="margin-left:0.75rem;">Download PDF</a>
</div>
{% elif game["is_complete"] and not locked %}
<div class="banner banner-waiting">
    Board is full! Waiting for the host to release the numbers...
</div>
{% elif not locked %}
<p class="hint">Click any open spot to claim it. Numbers will be revealed by the host after the board fills up.</p>
{% endif %}

{% if game["square_price"] or game["payout_info"] %}
<div class="pricing-box">
    {% if game["square_price"] %}<span><strong>Price:</strong> {{ game["square_price"] }}</span>{% endif %}
    {% if game["payout_info"] %}<span><strong>Payout:</strong> {{ game["payout_info"] }}</span>{% endif %}
</div>
{% endif %}

{% if payment_methods %}
<div class="payment-box">
    <strong>Pay the host:</strong>
    {% for pm in payment_methods %}
    <span class="payment-item"><span class="payment-label">{{ pm.label }}:</span> {{ pm.username }}</span>
    {% endfor %}
</div>
{% endif %}

{% if at_limit and not locked %}
<div class="banner banner-waiting">
    {% if has_pending_request %}
        You've used all your squares. Request pending â€” waiting for host approval.
    {% else %}
        You've used all your squares.
        <form method="post" action="{{ url_for('request_squares', game_id=game_id) }}" style="display:inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-small btn-release" style="margin-left:0.75rem;">Request More Squares</button>
        </form>
    {% endif %}
</div>
{% endif %}

<div class="grid-wrapper">
    <div class="team-label-x">{{ game["team_x"] }}</div>
    <div class="grid-with-label">
        <div class="team-label-y">{{ game["team_y"] }}</div>
        <table class="game-grid">
            <tr>
                <th class="corner-cell"></th>
                {% for c in range(10) %}
                <th class="number-cell">{% if game["numbers_released"] %}{{ col_numbers[c] }}{% else %}?{% endif %}</th>
                {% endfor %}
            </tr>
            {% for r in range(1, 11) %}
            <tr>
                <th class="number-cell">{% if game["numbers_released"] %}{{ row_numbers[r-1] }}{% else %}?{% endif %}</th>
                {% for c in range(1, 11) %}
                <td class="{% if grid[r][c] == 'VOID' %}void{% elif grid[r][c] %}claimed{% else %}open{% endif %}">
                    {% if grid[r][c] == 'VOID' %}
                        <span class="void-label">VOID</span>
                    {% elif grid[r][c] %}
                        <span class="player-name">{{ grid[r][c] }}</span>
                    {% else %}
                        <form method="post" action="{{ url_for('claim_spot', game_id=game_id) }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <input type="hidden" name="row" value="{{ r }}">
                            <input type="hidden" name="col" value="{{ c }}">
                            <button type="submit" class="claim-btn"></button>
                        </form>
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </table>
    </div>
</div>

<div class="card" style="margin-top:1.5rem;">
    <h3>Chat with Host</h3>
    {% if chat_messages %}
    <div class="chat-thread">
        {% for msg in chat_messages %}
        <div class="chat-bubble chat-bubble-{{ msg['sender_type'] }}">
            <span class="chat-sender">{{ "Host" if msg["sender_type"] == "host" else player_name }}</span>
            <p>{{ msg["message"] }}</p>
            <span class="chat-time">{{ msg["sent_at"][:16].replace("T", " ") }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    <form method="post" action="{{ url_for('message_host', game_id=game_id) }}" class="chat-reply-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="text" name="message" placeholder="Type a message..." maxlength="500" required class="input chat-reply-input">
        <button type="submit" class="btn btn-primary btn-small">Send</button>
    </form>
</div>
{% endblock %}
